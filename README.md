# kindfs
Index FS into a database, then easily make queries e.g. to find duplicates files/dirs, or mount the index with FUSE.

At the moment, the only DB supported is SQLite3.

Files are scanned with their metadata (e.g. file permissions, size, etc), filetype (from libmagic), and hashed contents (from xxhash). A pseudo-hash is then generated for dirs based on the dir contents (hashes from subfiles and pseudo-hash from subdirs). It is assumed that two files or dirs are "likely identical" when they have the same size and same hash. WARNING : since scanning speed was important to me, the hash is only made on the first/middle/last 1 MB of a file i.e. two files of identical size and different contents may exhibit the same hash (this is why (among other things) you should always double-check when this program identifies and returns candidate duplicate files/dirs).

Indexing should properly support (and not fail) when a part of the filesystem uses a different encoding (e.g. an old backup)

This program is in early phase and still not finished. Expect bugs ! The DB schema is simple but not optimal (and certainly not 3NF), and some informations are duplicate (e.g. 'parentdir/name' is equivalent to 'path', but all 3 fields were convenient for performance with sqlite indexes and FUSE)

## Usage
For the moment, this app is only tested on Linux (although it should work also work on BSD and other UNIX systems such as MacOS as long as you have FUSE). A prerequisite is to have the following packages installed : `pip install xxhash numpy fusepy python-magic`

Then the CLI has the following options : `kindfs <dbfile> <command> [args]`
* `kindfs <dbfile> scan <path> [-R]` : creates the sqlite file dbfile and scans the filesystem under `path/`. For performance, it is strongly adviced to have the DB on an SSD or in RAM. Depending on your situation. Of course the app must have the proper access rights to scan the filesystem. Adding `-R` performs a reset (if the DB file was already there) while otherwise the script attempts to resume scanning if it was previously started and aborted for any reason (useful for very large filesystems where scanning takes hours)
* `kindfs <dbfile> showdups [-l num] [-m <mountpoint>] [-k]` : shows all duplicate entries (files or dirs), by decreasing size. if `-k` is specified, result is ordered by decreasing number of childs (for dirs) instead of size. If `-l num` is specified, only the `num` first entries are returned. Adding `-m <mountpoint>` enables to do an additional check on the filesystem in case some files would have been deleted in the meanwhile
* `kindfs <dbfile> isincluded <dir1> <dir2> [-m <mountpoint>] [-i] [-n]` : checks whether all files from dir1 are present in dir2 (regardless of files/dirs structure). `-i` shows files that in dir1 _are_ included in dir2, while `-n` shows files in dir1 that _are not_ included in dir2 (at least `-n` or `-i` must be specified). Adding `-m <mountpoint>` enables to do an additional check on the filesystem in case some files would have been deleted in the meanwhile
* `kindfs <dbfile> diff <dir1> <dir2>` : equivalent to `kindfs <dbfile> isincluded <dir1> <dir2> -n` + `kindfs <dbfile> isincluded <dir2> <dir1> -n` i.e. will display all files from one side that are not on the other side
* `kindfs <dbfile1> comparedb <dbfile2>` : will display all entries from one DB that are not on the other DB (i.e. compares two versions of a DB, assuming that the path prefix is identical). Useful to double-check that re-organizing files and deleted duplicate entries did not end up with mistakenly deleting some files that had no duplicates (e.g. in order to restore them from an older backup before overwriting those backups).
* `kindfs <dbfile> dump <dir>` : dumps the contents of an indexed dir, with hashes and sizes in front of paths
* `kindfs <dbfile> mount <mountpoint>` : mounts the DB under mountpoint/ using FUSE (read-only at the moment, and only tested on Linux !). Then any tools including `diff -r` and `find` can be used.
  * Notice that `st_size` is mapped to the pseudo file contents generated by the FUSEFS (where files are all text files containing the hash+length of the real indexed file in the DB), and is different from the exposed size from `st_blocks` (which maps the real size of the file in the DB). This enables mc and du to report the real file size, while text editors can also properly read and show the summarized contents.
  * By the way, let's remind that in some situations on usual filesystems such as ext4, files can have identical contents/size/filename and yet have a different size returned by `du -s` (but identical size returned with `du -sb`. Another way to see it is to compare with `find -type f -printf "%8b %10s\t%p\n"` and see that number of blocks differ despite real size is identical). This is because the default behavior for `du` is to rely on st_block, which may differ between identical files if the underlying filesystem is fragmented while `du -b` uses st_size i.e. the real file size
* `kindfs <dbfile> inodes [-l num] [-m <mountpoint>]` : same as `showdups` but only return entries with identical inodes (i.e. those do not "eat" space on the filesystem, yet this information can be useful when trying to reorganize data, + having hard links can be error-prone in some cases when you think you have independent files whereas they are effectively pointing to the same data...)
* `kindfs <filename> computehash` : compute hash number with the same algorithm that is used when scanning the filesystem. Useful for some double-checks
* `kindfs <filename> check_zerofile` : check if a file is 100% made of zeros (useful for some double-checks)
* (more to come once it is better tested...)

## DISCLAIMER
You should read and understand the GPLv3 license (including their sections "Disclaimer of Warranty" and "Limitation of Liability"). In particular : although this tool can help detecting duplicate files, it may contain bugs, return wrong informations, behave in unintended ways. Use this software at your own risk, and it is adviced to double-check the results and never delete files/dirs unless you are sure of what you are doing !
